<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Pi-tMaster v1.0.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #121212;
            color: #eee;
            margin: 0;
            padding: 1em;
        }

        h1 {
            color: #f05a28;
            margin-bottom: 1em;
        }

        .sensor {
            background: #1e1e1e;
            border-radius: 12px;
            margin: 1em auto;
            padding: 1em;
            max-width: 300px;
            box-shadow: 0 0 10px rgba(240, 90, 40, 0.5);
        }

        .sensor.error {
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        .temp {
            font-size: 3em;
            margin: 0.3em 0;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.9em;
            margin: 0.5em 0;
        }

        .timestamp {
            font-size: 0.9em;
            color: #aaa;
            margin: 1em 0;
        }

        .controls {
            background: #1e1e1e;
            border-radius: 12px;
            margin: 2em auto;
            padding: 1em;
            max-width: 400px;
        }

        .control-btn {
            background: #f05a28;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0.5em;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            width: 200px;
        }

        .control-btn:hover {
            background: #d84a18;
        }

        .control-btn.danger {
            background: #dc3545;
        }

        .control-btn.danger:hover {
            background: #c82333;
        }

        .control-btn.success {
            background: #28a745;
        }

        .control-btn.success:hover {
            background: #218838;
        }

        .control-btn.info {
            background: #17a2b8;
        }

        .control-btn.info:hover {
            background: #138496;
        }

        .power-status {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 1em;
            margin: 1em auto;
            max-width: 300px;
            text-align: left;
        }

        .status-item {
            margin: 0.5em 0;
            display: flex;
            justify-content: space-between;
        }

        .status-label {
            color: #aaa;
        }

        .status-value {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-value.warning {
            color: #ff9800;
        }

        .status-value.error {
            color: #f44336;
        }

        .notification {
            background: #333;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            display: none;
        }

        .notification.success {
            background: #2d5016;
            color: #8bc34a;
        }

        .notification.error {
            background: #5c2a2a;
            color: #f44336;
        }

        .notification.info {
            background: #1a3c5a;
            color: #64b5f6;
        }

        .form-group {
            margin: 1em 0;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 0.5em;
            color: #aaa;
        }

        input, select {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #2a2a2a;
            color: white;
            box-sizing: border-box;
        }

        .calibration-points {
            margin-top: 1em;
            text-align: left;
        }

        .point {
            background: #2a2a2a;
            padding: 0.5em;
            margin: 0.5em 0;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</head>

<body>
    <h1>Pi-tMaster v1.0.0</h1>

    <div id="smoker_left" class="sensor">
        <h2>Smoker Left</h2>
        <div class="temp" id="smoker_left_temp">-- ¬∞F</div>
        <div class="error-message" id="smoker_left_error"></div>
    </div>

    <div id="smoker_right" class="sensor">
        <h2>Smoker Right</h2>
        <div class="temp" id="smoker_right_temp">-- ¬∞F</div>
        <div class="error-message" id="smoker_right_error"></div>
    </div>

    <div id="meat_probe" class="sensor">
        <h2>Meat Probe</h2>
        <div class="temp" id="meat_probe_temp">-- ¬∞F</div>
        <div class="error-message" id="meat_probe_error"></div>
    </div>

    <div class="timestamp" id="timestamp">Last Updated: --</div>

    <!-- System Controls Section -->
    <div class="controls">
        <h3>‚öôÔ∏è System Controls</h3>

        <!-- Notification Area -->
        <div id="notification" class="notification"></div>

        <!-- Control Buttons -->
        <button class="control-btn info" onclick="getPowerStatus()">üìä Check Power Status</button>
        <button class="control-btn success" onclick="enableLowPower()">üîã Enable Low Power</button>
        <button class="control-btn" onclick="enableFullPower()">üöÄ Enable Full Power</button>
        <button class="control-btn info" onclick="testSensors()">üîç Test Sensors</button>
        <button class="control-btn danger" onclick="shutdownSystem()">‚èª Shutdown System</button>
        <button class="control-btn danger" onclick="rebootSystem()">üîÑ Reboot System</button>
    </div>

    <div id="powerStatus" class="power-status" style="display: none;">
        <h3>üîã Power Status</h3>
        <div class="status-item">
            <span class="status-label">CPU Governor:</span>
            <span class="status-value" id="cpuGovernor">--</span>
        </div>
        <div class="status-item">
            <span class="status-label">CPU Frequency:</span>
            <span class="status-value" id="cpuFreq">--</span>
        </div>
        <div class="status-item">
            <span class="status-label">Min Frequency:</span>
            <span class="status-value" id="cpuMinFreq">--</span>
        </div>
        <div class="status-item">
            <span class="status-label">Max Frequency:</span>
            <span class="status-value" id="cpuMaxFreq">--</span>
        </div>
        <div class="status-item">
            <span class="status-label">System Mode:</span>
            <span class="status-value" id="systemMode">--</span>
        </div>
        <div class="status-item">
            <span class="status-label">Response Time:</span>
            <span class="status-value" id="systemUptime">--</span>
        </div>
    </div>

    <!-- Calibration Controls Section -->
    <div class="controls">
        <h3>üîß Calibration Controls</h3>
        
        <div class="form-group">
            <label for="calibrationSensor">Sensor:</label>
            <select id="calibrationSensor">
                <option value="smoker_left">Smoker Left</option>
                <option value="smoker_right">Smoker Right</option>
                <option value="meat_probe">Meat Probe</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="actualTemp">Actual Known Temperature (¬∞C):</label>
            <input type="number" id="actualTemp" step="0.1" placeholder="Enter known reference temperature">
        </div>
        
        <button class="control-btn success" onclick="addCalibrationPoint()">‚ûï Add Calibration Point</button>
        <button class="control-btn info" onclick="getCalibrationStatus()">üìä Check Calibration Status</button>
        <button class="control-btn danger" onclick="clearCalibration()">üóëÔ∏è Clear Calibration</button>
        
        <div id="calibrationStatus" class="power-status" style="display: none; margin-top: 1em;">
            <h4>Calibration Status</h4>
            <div id="calibrationDetails"></div>
        </div>
    </div>

    <script>
        // Temperature update function
        async function updateTemps() {
            try {
                const res = await fetch('/data');
                const json = await res.json();

                // Update temperatures and errors for each sensor
                const sensors = ['smoker_left', 'smoker_right', 'meat_probe'];
                sensors.forEach(sensor => {
                    const tempElement = document.getElementById(`${sensor}_temp`);
                    const errorElement = document.getElementById(`${sensor}_error`);
                    const sensorElement = document.getElementById(sensor);
                    
                    if (json[sensor].error) {
                        tempElement.innerText = "ERROR";
                        errorElement.innerText = json[sensor].error;
                        sensorElement.classList.add('error');
                    } else {
                        tempElement.innerText = json[sensor].temp_f + " ¬∞F";
                        errorElement.innerText = "";
                        sensorElement.classList.remove('error');
                    }
                });

                document.getElementById('timestamp').innerText = "Last Updated: " + json.last_updated;
            } catch (e) {
                console.error("Error fetching data:", e);
                showNotification('Error fetching temperature data', 'error');
            }
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Power status function
        async function getPowerStatus() {
            try {
                const res = await fetch('/powerstatus');
                const data = await res.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                const statusDiv = document.getElementById('powerStatus');

                // Update all fields from JSON data
                document.getElementById('cpuGovernor').textContent = data.cpu_governor || '--';
                document.getElementById('cpuFreq').textContent = (data.cpu_cur_freq || '--') + ' MHz';
                document.getElementById('cpuMinFreq').textContent = (data.cpu_min_freq || '--') + ' MHz';
                document.getElementById('cpuMaxFreq').textContent = (data.cpu_max_freq || '--') + ' MHz';
                document.getElementById('systemMode').textContent = data.power_mode || '--';

                // Get response time
                const responseTime = await getSystemResponseTime();
                document.getElementById('systemUptime').textContent = responseTime;

                // Color code based on power mode
                const modeElement = document.getElementById('systemMode');
                if (data.power_mode && data.power_mode.includes('LOW POWER')) {
                    modeElement.className = 'status-value success';
                } else if (data.power_mode && data.power_mode.includes('FULL POWER')) {
                    modeElement.className = 'status-value warning';
                } else {
                    modeElement.className = 'status-value error';
                }

                statusDiv.style.display = 'block';
                showNotification('Power status updated successfully');

            } catch (e) {
                console.error("Error fetching power status:", e);
                showNotification('Error getting power status: ' + e.message, 'error');
            }
        }

        // Get system response time
        async function getSystemResponseTime() {
            try {
                const startTime = performance.now();
                await fetch('/data');
                const responseTime = ((performance.now() - startTime)).toFixed(1) + ' ms';
                return responseTime;
            } catch (e) {
                return 'Unknown';
            }
        }

        // Enable low power mode
        async function enableLowPower() {
            try {
                showNotification('Enabling low power mode...', 'info');
                const res = await fetch('/enable-low-power');
                const result = await res.text();
                showNotification('Low power mode enabled successfully');
                setTimeout(getPowerStatus, 2000);
            } catch (e) {
                console.error("Error enabling low power:", e);
                showNotification('Error enabling low power mode', 'error');
            }
        }

        // Enable full power mode
        async function enableFullPower() {
            try {
                showNotification('Enabling full power mode...', 'info');
                const res = await fetch('/enable-full-power');
                const result = await res.text();
                showNotification('Full power mode enabled successfully');
                setTimeout(getPowerStatus, 2000);
            } catch (e) {
                console.error("Error enabling full power:", e);
                showNotification('Error enabling full power mode', 'error');
            }
        }

        // Test sensors
        async function testSensors() {
            try {
                showNotification('Testing sensors...', 'info');
                const res = await fetch('/sensor/test');
                const results = await res.json();
                
                let message = "Sensor Test Results:\n";
                for (const [sensor, data] of Object.entries(results)) {
                    message += `${sensor}: ${JSON.stringify(data.samples)}\n`;
                }
                
                showNotification(message, 'info');
            } catch (e) {
                showNotification('Error testing sensors: ' + e.message, 'error');
            }
        }

        // Shutdown function
        async function shutdownSystem() {
            const confirmed = confirm('‚ö†Ô∏è ARE YOU SURE YOU WANT TO SHUTDOWN THE SYSTEM?\n\nThis will turn off the Raspberry Pi completely.');
            if (confirmed) {
                try {
                    showNotification('System shutdown initiated...', 'error');
                    await fetch('/shutdown');
                    document.querySelectorAll('.temp').forEach(el => {
                        el.textContent = 'SHUTTING DOWN...';
                    });
                    document.getElementById('timestamp').textContent = 'System shutdown initiated';
                } catch (e) {
                    showNotification('Shutdown command sent. System should power off shortly.', 'error');
                }
            }
        }

        // Reboot function
        async function rebootSystem() {
            const confirmed = confirm('‚ö†Ô∏è ARE YOU SURE YOU WANT TO REBOOT THE SYSTEM?\n\nThe Raspberry Pi will restart.');
            if (confirmed) {
                try {
                    showNotification('System reboot initiated...', 'error');
                    await fetch('/reboot');
                    document.querySelectorAll('.temp').forEach(el => {
                        el.textContent = 'REBOOTING...';
                    });
                    document.getElementById('timestamp').textContent = 'System reboot initiated';
                } catch (e) {
                    showNotification('Reboot command sent. System should restart shortly.', 'error');
                }
            }
        }

        // Calibration functions
        async function addCalibrationPoint() {
            const sensor = document.getElementById('calibrationSensor').value;
            const actualTemp = parseFloat(document.getElementById('actualTemp').value);
            
            if (isNaN(actualTemp)) {
                showNotification('Please enter the actual known temperature', 'error');
                return;
            }
            
            try {
                showNotification('Adding calibration point...', 'info');
                const response = await fetch('/calibration/add_point', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sensor_name: sensor,
                        actual_temp: actualTemp
                    })
                });
                const result = await response.json();
                showNotification(result.message, result.status);
                
                // Clear input
                document.getElementById('actualTemp').value = '';
                
                // Refresh calibration status
                setTimeout(getCalibrationStatus, 1000);
                
            } catch (e) {
                showNotification('Error adding calibration point: ' + e.message, 'error');
            }
        }
        
        async function getCalibrationStatus() {
            const sensor = document.getElementById('calibrationSensor').value;
            
            try {
                const response = await fetch('/calibration/status');
                const data = await response.json();
                const status = data[sensor];
                
                if (status.error) {
                    throw new Error(status.error);
                }
                
                const details = document.getElementById('calibrationDetails');
                let pointsHtml = '';
                
                if (status.points && status.points.length > 0) {
                    pointsHtml = '<div class="calibration-points"><strong>Calibration Points:</strong>';
                    status.points.forEach(point => {
                        const date = new Date(point.timestamp * 1000).toLocaleString();
                        pointsHtml += `
                            <div class="point">
                                Actual: ${point.actual_temp}¬∞C, 
                                Measured: ${point.measured_temp}¬∞C<br>
                                <small>${date}</small>
                            </div>
                        `;
                    });
                    pointsHtml += '</div>';
                }
                
                details.innerHTML = `
                    <div class="status-item">
                        <span class="status-label">Calibrated:</span>
                        <span class="status-value ${status.is_calibrated ? 'success' : 'error'}">
                            ${status.is_calibrated ? 'YES' : 'NO'}
                        </span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Points:</span>
                        <span class="status-value">${status.points_count}/3</span>
                    </div>
                    ${status.is_calibrated ? `
                    <div class="status-item">
                        <span class="status-label">Slope:</span>
                        <span class="status-value">${status.slope.toFixed(4)}</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Intercept:</span>
                        <span class="status-value">${status.intercept.toFixed(4)}¬∞C</span>
                    </div>
                    ` : ''}
                    ${pointsHtml}
                `;
                
                document.getElementById('calibrationStatus').style.display = 'block';
                
            } catch (e) {
                showNotification('Error getting calibration status: ' + e.message, 'error');
            }
        }
        
        async function clearCalibration() {
            const sensor = document.getElementById('calibrationSensor').value;
            const confirmed = confirm(`Clear calibration for ${sensor}?`);
            
            if (confirmed) {
                try {
                    const response = await fetch('/calibration/clear', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({sensor_name: sensor})
                    });
                    const result = await response.json();
                    showNotification(result.message, result.status);
                    
                    // Hide status display
                    document.getElementById('calibrationStatus').style.display = 'none';
                    
                } catch (e) {
                    showNotification('Error clearing calibration: ' + e.message, 'error');
                }
            }
        }
        
        // Update temperatures every 3 seconds
        setInterval(updateTemps, 3000);
        updateTemps();
    </script>
</body>

</html>