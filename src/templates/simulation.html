{% extends "base.html" %}

{% block title %}Performance Testing - Pi-tMaster{% endblock %}

{% block page_title %}Performance Testing{% endblock %}

{% block content %}
<div class="card">
    <h2 style="text-align: center; margin-bottom: 1rem;">Temperature Simulation Testing</h2>
    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1.5rem;">
        Test JSON response integrity, Flask server limits, and integer overflow risks
    </p>

    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
        <div style="text-align: center; margin-bottom: 0.5rem;">
            <strong>ğŸ”¬ Testing Mode:</strong>
            <span id="simulationStatus" style="color: var(--warning);">Checking...</span>
        </div>
        <div style="font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
            Type-K Range: -200Â°C to 1350Â°C | Absolute Zero: -273.15Â°C
        </div>
    </div>
</div>

<div class="card">
    <h3>Simulation Mode Control</h3>
    
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <label for="simulationToggle" style="margin: 0; flex: 1;">
            <strong>Enable Simulation Mode:</strong>
        </label>
        <label class="switch">
            <input type="checkbox" id="simulationToggle" onchange="toggleSimulationMode()">
            <span class="slider"></span>
        </label>
    </div>
    
    <div id="simulationWarning" style="background: #5c2a2a; padding: 0.75rem; border-radius: 6px; display: none;">
        <strong>âš ï¸ Warning:</strong> Simulation mode overrides real sensor data. Use for testing only.
    </div>
</div>

<div class="card simulation-controls" id="simulationControls" style="opacity: 0.5; pointer-events: none;">
    <h3>Set Individual Sensor Temperature</h3>
    
    <div class="form-group">
        <label for="sensorSelect">Select Sensor:</label>
        <select id="sensorSelect">
            <option value="smoker_left">ğŸ”¥ Smoker Left</option>
            <option value="smoker_right">ğŸ”¥ Smoker Right</option>
            <option value="meat_probe">ğŸ¥© Meat Probe</option>
        </select>
    </div>

    <div class="form-group">
        <label for="individualTemp">Temperature (Â°C):</label>
        <input type="number" id="individualTemp" step="0.1" value="25.0" placeholder="Enter temperature">
    </div>

    <button class="btn info" onclick="setIndividualTemperature()">
        <span>ğŸ¯</span> Set Individual Temperature
    </button>
</div>

<div class="card simulation-controls" id="bulkControls" style="opacity: 0.5; pointer-events: none;">
    <h3>Set All Sensors Temperature</h3>
    
    <div class="form-group">
        <label for="allTemp">Temperature for All Sensors (Â°C):</label>
        <input type="number" id="allTemp" step="0.1" value="25.0" placeholder="Enter temperature">
    </div>

    <button class="btn warning" onclick="setAllTemperatures()">
        <span>ğŸ¯</span> Set All Temperatures
    </button>
</div>

<div class="card simulation-controls" id="presetControls" style="opacity: 0.5; pointer-events: none;">
    <h3>Quick Test Presets</h3>
    
    <div class="status-grid">
        <button class="btn" style="margin: 0.25rem; padding: 0.75rem;" onclick="setPresetTemperature(-200)">
            <span>â„ï¸</span> -200Â°C
        </button>
        <button class="btn" style="margin: 0.25rem; padding: 0.75rem;" onclick="setPresetTemperature(0)">
            <span>ğŸ§Š</span> 0Â°C
        </button>
        <button class="btn" style="margin: 0.25rem; padding: 0.75rem;" onclick="setPresetTemperature(25)">
            <span>ğŸŒ¡ï¸</span> 25Â°C
        </button>
        <button class="btn" style="margin: 0.25rem; padding: 0.75rem;" onclick="setPresetTemperature(100)">
            <span>â™¨ï¸</span> 100Â°C
        </button>
        <button class="btn" style="margin: 0.25rem; padding: 0.75rem;" onclick="setPresetTemperature(500)">
            <span>ğŸ”¥</span> 500Â°C
        </button>
        <button class="btn" style="margin: 0.25rem; padding: 0.75rem;" onclick="setPresetTemperature(1350)">
            <span>ğŸ’¥</span> 1350Â°C
        </button>
    </div>
</div>

<div class="card simulation-controls" id="testControls" style="opacity: 0.5; pointer-events: none;">
    <h3>Extreme Value Testing</h3>
    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
        Test JSON response integrity with boundary conditions and overflow risks
    </p>

    <button class="btn danger" onclick="runExtremeTests()">
        <span>ğŸ§ª</span> Run Extreme Value Tests
    </button>

    <div id="testResults" style="display: none; margin-top: 1rem;">
        <h4>Test Results</h4>
        <div id="testResultsContent" style="max-height: 300px; overflow-y: auto;"></div>
    </div>
</div>

<div class="card">
    <h3>Current Simulation Status</h3>
    <button class="btn info" onclick="getSimulationStatus()">
        <span>ğŸ”„</span> Refresh Status
    </button>
    
    <div id="simulationData" style="margin-top: 1rem;">
        <!-- Status will be populated here -->
    </div>
</div>

<div class="card">
    <h3>Testing Notes</h3>
    <div style="background: #2a2a2a; padding: 1rem; border-radius: 8px;">
        <div style="margin-bottom: 0.5rem;"><strong>What to Test:</strong></div>
        <ul style="color: var(--text-secondary); padding-left: 1.5rem; font-size: 0.9rem;">
            <li>JSON response integrity with extreme values</li>
            <li>Flask server handling of large/small numbers</li>
            <li>Integer overflow in temperature calculations</li>
            <li>Type-K thermocouple range validation</li>
            <li>Frontend display of extreme temperatures</li>
            <li>Database/serialization limits</li>
        </ul>
    </div>
</div>

<style>
    /* Toggle switch styles */
    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--primary-color);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    /* Control states */
    .simulation-controls.enabled {
        opacity: 1 !important;
        pointer-events: all !important;
    }
    
    .simulation-controls.disabled {
        opacity: 0.5 !important;
        pointer-events: none !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>

    // Check simulation status on page load
    async function checkSimulationStatus() {
        try {
            const response = await fetch('/simulation/status');
            const data = await response.json();
            
            const statusElement = document.getElementById('simulationStatus');
            toggle = document.getElementById('simulationToggle');
            
            if (data.simulation_mode) {
                statusElement.textContent = 'ACTIVE';
                statusElement.style.color = 'var(--success)';
                toggle.checked = true;
                enableSimulationControls(true);
            } else {
                statusElement.textContent = 'INACTIVE - Using Real Sensors';
                statusElement.style.color = 'var(--warning)';
                toggle.checked = false;
                enableSimulationControls(false);
            }
        } catch (e) {
            console.error('Error checking simulation status:', e);
            document.getElementById('simulationStatus').textContent = 'ERROR';
            document.getElementById('simulationStatus').style.color = 'var(--error)';
        }
    }

    // Toggle simulation mode
    async function toggleSimulationMode() {
        const toggle = document.getElementById('simulationToggle');
        const enabled = toggle.checked;
        
        try {
            showNotification(`${enabled ? 'Enabling' : 'Disabling'} simulation mode...`, 'info');
            const response = await fetch('/simulation/set_mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    enabled: enabled
                })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                showNotification(result.message, 'success');
                checkSimulationStatus(); // Refresh status display
                
                // Show/hide warning
                warning = document.getElementById('simulationWarning');
                if (enabled) {
                    warning.style.display = 'block';
                } else {
                    warning.style.display = 'none';
                }
            } else {
                showNotification('Error: ' + result.message, 'error');
                // Revert toggle if failed
                toggle.checked = !enabled;
            }
            
        } catch (e) {
            showNotification('Error toggling simulation mode: ' + e.message, 'error');
            // Revert toggle if error
            toggle.checked = !enabled;
        }
    }

    // Enable/disable simulation controls
    function enableSimulationControls(enabled) {
        const controls = document.querySelectorAll('.simulation-controls');
        controls.forEach(control => {
            if (enabled) {
                control.classList.remove('disabled');
                control.classList.add('enabled');
            } else {
                control.classList.remove('enabled');
                control.classList.add('disabled');
            }
        });
    }

    // Set individual sensor temperature
    async function setIndividualTemperature() {
        const sensor = document.getElementById('sensorSelect').value;
        const temp = parseFloat(document.getElementById('individualTemp').value);
        
        if (isNaN(temp)) {
            showNotification('Please enter a valid temperature', 'error');
            return;
        }
        
        try {
            showNotification(`Setting ${sensor} to ${temp}Â°C...`, 'info');
            const response = await fetch('/simulation/set_temperature', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sensor_name: sensor,
                    temperature: temp
                })
            });
            const result = await response.json();
            showNotification(result.message, result.status);
            
        } catch (e) {
            showNotification('Error setting temperature: ' + e.message, 'error');
        }
    }

    // Set all sensors to the same temperature
    async function setAllTemperatures() {
        const temp = parseFloat(document.getElementById('allTemp').value);
        
        if (isNaN(temp)) {
            showNotification('Please enter a valid temperature', 'error');
            return;
        }
        
        try {
            showNotification(`Setting all sensors to ${temp}Â°C...`, 'info');
            const response = await fetch('/simulation/set_all', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    temperature: temp
                })
            });
            const result = await response.json();
            showNotification(result.message, result.status);
            
        } catch (e) {
            showNotification('Error setting temperatures: ' + e.message, 'error');
        }
    }

    // Set preset temperature for all sensors
    async function setPresetTemperature(temp) {
        try {
            showNotification(`Setting all sensors to ${temp}Â°C...`, 'info');
            const response = await fetch('/simulation/set_all', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    temperature: temp
                })
            });
            const result = await response.json();
            showNotification(result.message, result.status);
            
            // Update the input fields
            document.getElementById('individualTemp').value = temp;
            document.getElementById('allTemp').value = temp;
            
        } catch (e) {
            showNotification('Error setting temperature: ' + e.message, 'error');
        }
    }

    // Run extreme value tests
    async function runExtremeTests() {
        try {
            showNotification('Running extreme value tests...', 'info');
            const response = await fetch('/simulation/test_extremes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                displayTestResults(result.results);
                showNotification(`Completed ${result.results.length} test cases`, 'success');
            } else {
                showNotification('Test failed: ' + result.message, 'error');
            }
            
        } catch (e) {
            showNotification('Error running tests: ' + e.message, 'error');
        }
    }

    // Display test results
    function displayTestResults(results) {
        const container = document.getElementById('testResultsContent');
        container.innerHTML = '';
        
        results.forEach((test, index) => {
            const testDiv = document.createElement('div');
            testDiv.style.background = '#2a2a2a';
            testDiv.style.padding = '0.75rem';
            testDiv.style.borderRadius = '6px';
            testDiv.style.marginBottom = '0.5rem';
            testDiv.style.borderLeft = `4px solid ${test.status === 'success' ? 'var(--success)' : 'var(--error)'}`;
            
            testDiv.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 0.25rem;">${test.test_case}</div>
                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                    Input: ${test.temp_c}Â°C
                    ${test.status === 'success' ? 
                        ` | Output: ${test.json_response}` : 
                        ` | Error: ${test.error}`
                    }
                </div>
            `;
            
            container.appendChild(testDiv);
        });
        
        document.getElementById('testResults').style.display = 'block';
    }

    // Get simulation status
    async function getSimulationStatus() {
        try {
            const response = await fetch('/simulation/status');
            const data = await response.json();
            
            const container = document.getElementById('simulationData');
            container.innerHTML = `
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Smoker Left</div>
                        <div class="status-value">${data.current_temperatures.smoker_left}Â°C</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Smoker Right</div>
                        <div class="status-value">${data.current_temperatures.smoker_right}Â°C</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Meat Probe</div>
                        <div class="status-value">${data.current_temperatures.meat_probe}Â°C</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 1rem; color: var(--text-secondary); font-size: 0.9rem;">
                    Type-K Range: ${data.type_k_range.min}Â°C to ${data.type_k_range.max}Â°C
                </div>
            `;
            
        } catch (e) {
            showNotification('Error getting simulation status: ' + e.message, 'error');
        }
    }

    // Initialize page
    checkSimulationStatus();
    getSimulationStatus();
</script>
{% endblock %}